<Page x:Class="RegistryRepairTool.Views.Pages.ManualEditPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:material="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:local="clr-namespace:RegistryRepairTool.ViewModels"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      mc:Ignorable="d"
      Title="Ручное редактирование реестра"
      Background="{DynamicResource MaterialDesignPaper}">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Панель навигации -->
        <Border Grid.Row="0" 
                CornerRadius="4"
                Background="{DynamicResource MaterialDesignCardBackground}"
                Padding="8"
                Margin="0,0,0,16"
                Effect="{StaticResource MaterialDesignShadowDepth1}">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBox x:Name="PathTextBox" 
                         Text="{Binding CurrentPath, UpdateSourceTrigger=PropertyChanged}"
                         material:HintAssist.Hint="Путь в реестре"
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                         MinWidth="300"
                         KeyDown="TextBox_KeyDown"/>

                <Button Command="{Binding NavigateCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Margin="8,0,0,0"
                        ToolTip="Перейти">
                    <StackPanel Orientation="Horizontal">
                        <material:PackIcon Kind="ArrowRight" Margin="0,0,4,0"/>
                        <TextBlock Text="Перейти"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding RefreshCommand}"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Margin="8,0,0,0"
                        ToolTip="Обновить">
                    <material:PackIcon Kind="Refresh" />
                </Button>

                <Button Command="{Binding CreateKeyCommand}"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Margin="8,0,0,0"
                        ToolTip="Создать раздел">
                    <material:PackIcon Kind="FolderPlus" />
                </Button>

                <Button Command="{Binding DeleteKeyCommand}"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Margin="8,0,0,0"
                        ToolTip="Удалить раздел">
                    <material:PackIcon Kind="FolderRemove" />
                </Button>
            </StackPanel>
        </Border>

        <!-- Основное содержимое -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>

            <!-- Дерево реестра -->
            <Border Grid.Column="0" 
                    Margin="0,0,8,0"
                    CornerRadius="4"
                    Background="{DynamicResource MaterialDesignCardBackground}"
                    Effect="{StaticResource MaterialDesignShadowDepth1}">
                <TreeView x:Name="RegistryTree" 
                          ItemsSource="{Binding RootNodes}"
                          SelectedItemChanged="TreeView_SelectedItemChanged"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          BorderThickness="0"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto">
                    <TreeView.ItemContainerStyle>
                        <Style TargetType="{x:Type TreeViewItem}">
                            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Padding" Value="4,2"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TreeView.ItemContainerStyle>

                    <TreeView.Resources>
                        <HierarchicalDataTemplate DataType="{x:Type local:RegistryNode}" 
                                  ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <material:PackIcon Kind="Folder" 
                                   Margin="0,0,4,0"
                                   Foreground="{StaticResource PrimaryHueMidBrush}"/>
                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </HierarchicalDataTemplate>
                    </TreeView.Resources>
                </TreeView>
            </Border>

            <!-- Значения реестра -->
            <Border Grid.Column="1"
                    CornerRadius="4"
                    Background="{DynamicResource MaterialDesignCardBackground}"
                    Effect="{StaticResource MaterialDesignShadowDepth1}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Заголовок -->
                    <Border Grid.Row="0" 
                            Background="{DynamicResource PrimaryHueLightBrush}"
                            CornerRadius="4,4,0,0"
                            Padding="8">
                        <TextBlock Text="{Binding SelectedNode.FullPath}"
                                   Margin="0,2"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"
                                   TextTrimming="CharacterEllipsis"/>
                    </Border>

                    <!-- Список значений -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding SelectedNode.Values}"
                              SelectedItem="{Binding SelectedNode.SelectedValue, Mode=TwoWay}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserReorderColumns="False"
                              SelectionMode="Single"
                              SelectionUnit="FullRow"
                              BorderThickness="0"
                              HeadersVisibility="Column"
                              RowHeaderWidth="0"
                              GridLinesVisibility="None"
                              Background="Transparent">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Имя" 
                                                Binding="{Binding Name}"
                                                Width="*"
                                                ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"/>
                            <DataGridTextColumn Header="Тип" 
                                                Binding="{Binding Kind}"
                                                Width="Auto"
                                                ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"/>
                            <DataGridTextColumn Header="Значение" 
                                                Binding="{Binding Value}"
                                                Width="2*"
                                                ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"/>
                        </DataGrid.Columns>
                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Setter Property="Padding" Value="8,4"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Grid Background="{TemplateBinding Background}">
                                                <ContentPresenter VerticalAlignment="Center"/>
                                            </Grid>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.CellStyle>
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="Background" Value="Transparent"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}"/>
                                        <Setter Property="Foreground" Value="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                    </DataGrid>

                    <!-- Панель действий -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource MaterialDesignToolBarBackground}"
                            CornerRadius="0,0,4,4"
                            Padding="8">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Command="{Binding CreateValueCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    ToolTip="Создать значение">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Plus" Margin="0,0,4,0"/>
                                    <TextBlock Text="Создать"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding EditValueCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="8,0,0,0"
                                    ToolTip="Изменить значение">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Pencil" Margin="0,0,4,0"/>
                                    <TextBlock Text="Изменить"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding DeleteValueCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="8,0,0,0"
                                    ToolTip="Удалить значение">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Delete" Margin="0,0,4,0"/>
                                    <TextBlock Text="Удалить"/>
                                </StackPanel>
                            </Button>
                            <Button Command="{Binding ExportCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="8,0,0,0"
                                    ToolTip="Экспорт раздела">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Export" Margin="0,0,4,0"/>
                                    <TextBlock Text="Экспорт"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>