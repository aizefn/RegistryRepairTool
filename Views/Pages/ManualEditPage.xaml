<Page x:Class="RegistryRepairTool.Views.Pages.ManualEditPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:material="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:local="clr-namespace:RegistryRepairTool.ViewModels"
      xmlns:converters="clr-namespace:RegistryRepairTool.Utilities.Converters"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
TextOptions.TextFormattingMode="Display"
      TextOptions.TextRenderingMode="ClearType"
      SnapsToDevicePixels="True"
      UseLayoutRounding="True"
      mc:Ignorable="d"
      Title="Ручное редактирование реестра"
      Background="{DynamicResource MaterialDesignPaper}">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Navigation Panel -->
        <Border Grid.Row="0" 
                CornerRadius="4"
                Background="{DynamicResource MaterialDesignCardBackground}"
                Padding="8"
                Margin="0,0,0,16"
                Effect="{StaticResource MaterialDesignShadowDepth1}">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <!-- Path TextBox -->
                <TextBox x:Name="PathTextBox" 
                         Text="{Binding CurrentPath, UpdateSourceTrigger=PropertyChanged}"
                         material:HintAssist.Hint="Путь в реестре"
                         Style="{StaticResource MaterialDesignFloatingHintTextBox}"
                         MinWidth="300"
                         KeyDown="TextBox_KeyDown"/>

                <!-- Navigation Buttons -->
                <Button Command="{Binding NavigateCommand}"
                        Style="{StaticResource MaterialDesignFlatButton}"
                        Margin="8,0,0,0"
                        ToolTip="Перейти">
                    <StackPanel Orientation="Horizontal">
                        <material:PackIcon Kind="ArrowRight" Margin="0,0,4,0"/>
                        <TextBlock Text="Перейти"/>
                    </StackPanel>
                </Button>

                <Button Command="{Binding RefreshCommand}"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Margin="8,0,0,0"
                        ToolTip="Обновить">
                    <material:PackIcon Kind="Refresh"/>
                </Button>

                <!-- Key Operations -->
                <Button Command="{Binding CreateKeyCommand}"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Margin="8,0,0,0"
                        ToolTip="Создать раздел">
                    <material:PackIcon Kind="FolderPlus"/>
                </Button>

                <Button Command="{Binding DeleteKeyCommand}"
                        Style="{StaticResource MaterialDesignToolButton}"
                        Margin="8,0,0,0"
                        ToolTip="Удалить раздел">
                    <material:PackIcon Kind="FolderRemove"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>

            <!-- Registry Tree -->
            <Border Grid.Column="0" 
                    Margin="0,0,8,0"
                    CornerRadius="4"
                    Background="{DynamicResource MaterialDesignCardBackground}"
                    Effect="{StaticResource MaterialDesignShadowDepth1}">
                <TreeView x:Name="RegistryTree" 
                          ItemsSource="{Binding RootNodes}"
                          SelectedItemChanged="TreeView_SelectedItemChanged"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          BorderThickness="0"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          TextOptions.TextFormattingMode="Display"
          TextOptions.TextRenderingMode="ClearType"
          SnapsToDevicePixels="True"
          UseLayoutRounding="True">

                    <TreeView.ItemContainerStyle>
                        <Style TargetType="{x:Type TreeViewItem}">
                            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Padding" Value="4,2"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TreeView.ItemContainerStyle>

                    <TreeView.Resources>
                        <HierarchicalDataTemplate DataType="{x:Type local:RegistryNode}" 
                                  ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <material:PackIcon Kind="Folder" 
                                   Margin="0,0,4,0"
                                   Foreground="{StaticResource PrimaryHueMidBrush}"/>
                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </HierarchicalDataTemplate>
                    </TreeView.Resources>
                </TreeView>
            </Border>

            <!-- Registry Values -->
            <Border Grid.Column="1"
                    CornerRadius="4"
                    Background="{DynamicResource MaterialDesignCardBackground}"
                    Effect="{StaticResource MaterialDesignShadowDepth1}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Border Grid.Row="0" 
                            Background="{DynamicResource PrimaryHueLightBrush}"
                            CornerRadius="4,4,0,0"
                            Padding="8">
                        <TextBlock Text="{Binding SelectedNode.FullPath}"
                                   Margin="0,2"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource PrimaryHueLightForegroundBrush}"
                                   TextTrimming="CharacterEllipsis"/>
                    </Border>

                    <!-- Values List -->
                    <DataGrid Grid.Row="1"
          ItemsSource="{Binding SelectedNode.Values}"
          SelectedItem="{Binding SelectedNode.SelectedValue, Mode=TwoWay}"
          AutoGenerateColumns="False"
          CanUserAddRows="False"
          CanUserDeleteRows="False"
          CanUserReorderColumns="False"
          CanUserResizeRows="False"
          CanUserSortColumns="True"
          IsReadOnly="True"
          SelectionMode="Single"
          SelectionUnit="FullRow"
          BorderThickness="0"
          HeadersVisibility="Column"
          RowHeaderWidth="0"
          GridLinesVisibility="None"
          Background="Transparent"
          HorizontalGridLinesBrush="Transparent"
          VerticalGridLinesBrush="Transparent"
          EnableRowVirtualization="True"
          EnableColumnVirtualization="True"
          VirtualizingPanel.IsVirtualizing="True"
          VirtualizingPanel.VirtualizationMode="Recycling"
          TextOptions.TextFormattingMode="Display"
          TextOptions.TextRenderingMode="ClearType"
          SnapsToDevicePixels="True"
          UseLayoutRounding="True">

                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Имя" 
                          Binding="{Binding Name}"
                          Width="*"
                          IsReadOnly="True"
                          ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"
                          TextBlock.TextAlignment="Left"/>
                            <DataGridTextColumn Header="Тип" 
                          Binding="{Binding Kind}"
                          Width="Auto"
                          IsReadOnly="True"
                          ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"
                          TextBlock.TextAlignment="Left"/>
                            <DataGridTextColumn Header="Значение" 
                          Binding="{Binding Value, Converter={StaticResource RegistryValueConverter}}"
                          Width="2*"
                          IsReadOnly="True"
                          ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}"
                          TextBlock.TextAlignment="Left"/>
                        </DataGrid.Columns>

                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Setter Property="Padding" Value="8,4"/>
                                <Setter Property="IsTabStop" Value="False"/>
                                <Setter Property="TextOptions.TextFormattingMode" Value="Display"/>
                                <Setter Property="TextOptions.TextRenderingMode" Value="ClearType"/>
                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                                <Setter Property="UseLayoutRounding" Value="True"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Grid Background="{TemplateBinding Background}" 
                              SnapsToDevicePixels="True"
                              UseLayoutRounding="True">
                                                <ContentPresenter Margin="10,0,0,0" 
                                          VerticalAlignment="Center"
                                          TextOptions.TextFormattingMode="Display"
                                          TextOptions.TextRenderingMode="ClearType"
                                          SnapsToDevicePixels="True"/>
                                            </Grid>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </DataGrid.CellStyle>

                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderBrush" Value="Transparent"/>
                                <Setter Property="TextOptions.TextFormattingMode" Value="Display"/>
                                <Setter Property="TextOptions.TextRenderingMode" Value="ClearType"/>
                                <Setter Property="SnapsToDevicePixels" Value="True"/>
                                <Setter Property="UseLayoutRounding" Value="True"/>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}"/>
                                        <Setter Property="Foreground" Value="{DynamicResource PrimaryHueLightForegroundBrush}"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryHueMidBrush}"/>
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource PrimaryHueLightBrush}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                    </DataGrid>

                    <!-- Action Panel -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource MaterialDesignToolBarBackground}"
                            CornerRadius="0,0,4,4"
                            Padding="8">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Command="{Binding CreateValueCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    ToolTip="Создать значение">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Plus" Margin="0,0,4,0"/>
                                    <TextBlock Text="Создать"/>
                                </StackPanel>
                            </Button>

                            <Button Command="{Binding EditValueCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="8,0,0,0"
                                    ToolTip="Изменить значение">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Pencil" Margin="0,0,4,0"/>
                                    <TextBlock Text="Изменить"/>
                                </StackPanel>
                            </Button>

                            <Button Command="{Binding DeleteValueCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="8,0,0,0"
                                    ToolTip="Удалить значение">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Delete" Margin="0,0,4,0"/>
                                    <TextBlock Text="Удалить"/>
                                </StackPanel>
                            </Button>

                            <Button Command="{Binding ExportCommand}"
                                    Style="{StaticResource MaterialDesignFlatButton}"
                                    Margin="8,0,0,0"
                                    ToolTip="Экспорт раздела">
                                <StackPanel Orientation="Horizontal">
                                    <material:PackIcon Kind="Export" Margin="0,0,4,0"/>
                                    <TextBlock Text="Экспорт"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>